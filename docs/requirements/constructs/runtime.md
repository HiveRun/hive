# Construct Runtime

This document covers the runtime behavior of constructs. For configuration details see [Workspace & Templates](../configuration.md).

## Agent Orchestration
- Anchor on the official OpenCode SDK for all agent interactions (init sessions, send prompts, stream tool events, fetch artifacts). Avoid TUI screen scraping.
- Keep a local clone of <https://github.com/sst/opencode> in `vendor/opencode/` for reference only; production code must depend on the published `@opencode-ai/sdk` package, never the clone.
- Run constructs directly in the host environment so agents share the user's credentials, PATH, and dependencies; no supervised pods for v1.
- Before creating an OpenCode session, inspect the user's OpenCode config/auth store (`auth.json`) to confirm credentials exist for the provider the template demands; if missing, block the session and prompt the user to run `opencode auth login` (no additional runtime retries beyond surfacing the error toast).
- Assemble each agent session prompt from a base Markdown primer describing Synthetic, constructs, and the agent's role; append construct-specific context (task brief, running services, resolved ports/URLs, constraints on external resources).

## Persistence
- Use SQLite as the primary store for constructs, transcripts, statuses, and metadata so we gain ACID writes with minimal setup.
- Persist large artifacts, command logs, and diff bundles as raw files on disk referenced from the SQLite tables for fast streaming in the UI.
- Keep migration overhead light by versioning the schema alongside app releases and offering a simple `synthetic migrate` command.
- Record running service state (command, cwd, env, last-known status, pid if available). On startup, Synthetic should detect constructs marked active, probe each recorded PID with `kill -0` (does not terminate the process) to see which services survived, and offer a `synthetic services resume <construct>` command to replay the manifest for any missing processes.

## Workspace Discovery & Switching
- On first launch, prompt the operator to choose a directory; if it contains a `synthetic.config.ts`, register it immediately.
- When a directory contains multiple subdirectories, scan only the immediate children for `synthetic.config.ts` and offer those as registrable workspaces.
- Persist registrations in the global workspace registry (e.g., `~/.synthetic/workspaces.json`) and surface all entries via the sidebar or command menu so switching is a single action.
- Switching workspaces updates the active repo context, constructs list, and services in-place; because Synthetic runs as a single instance, it can coordinate port assignments and avoid collisions automatically.
- Construct templates, histories, and artifacts remain isolated to their workspace; Synthetic never mixes constructs across projects.

## Docker & Compose Support
- For `type: "docker"` services, Synthetic runs `docker run` with the declared `image`, `command` (optional), `ports`, `env`, and `volumes`; port requests pick an open host port, map it to the declared container port, and expose the value through the configured env name. Volume paths support `${constructDir}` templating so persistent data lives alongside the construct workspace.
- Docker services use deterministic container names (`synthetic-{constructId}-{serviceName}`) so stop commands can be autogenerated when omitted.
- For `type: "compose"`, point to a Compose file (`composePath`) and optional service filter; Synthetic parses the file, injects templated variables (including generated ports/env vars), and starts the selected services with the same status tracking/ready detection pipeline.
- When Compose is involved, generated per-service shims expose the same lifecycle hooks (ready pattern, stop) to keep the UI consistent.
